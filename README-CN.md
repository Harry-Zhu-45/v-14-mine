# Z3 扫雷求解器

> **⚠️ AI参与提示**：本项目在开发过程中使用了AI辅助编程。

一个使用 Z3 定理证明器来确定安全单元格和地雷的扫雷求解器，具有数学确定性。该应用程序支持多种游戏变体，并提供交互式 GUI 用于谜题输入和求解。

**🌐 语言**: **中文** | [English Version](README.md)

## 功能特点

- **精确求解器**：使用 Z3 约束求解来找到逻辑上确定的移动
- **多种变体**：支持标准、骑士和曼哈顿邻居规则
- **交互式 GUI**：基于 Pygame 的界面，便于谜题输入
- **撤销支持**：Ctrl+Z 撤销上一步操作
- **可配置网格**：可调整网格大小（3x3 至 20x20）和地雷数量
- **视觉反馈**：高亮显示安全单元格（绿色）和地雷单元格（红色）

## 架构

本项目采用 **模型-视图-表示器 (MVP)** 架构：

```txt
┌─────────────────────────────────────────────────────────────┐
│                        GUI 层 (视图)                        │
│  pygame_gui.py - Pygame 实现                                │
│  - 渲染网格和 UI 控件                                        │
│  - 处理用户输入事件                                          │
│  - 显示求解器结果                                            │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                     表示器层                                │
│  presenter.py - 模型和视图之间的中介                         │
│  - 处理用户交互                                              │
│  - 协调求解器调用                                            │
│  - 使用结果更新视图                                          │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                       模型层                                │
│  game_state.py - 管理游戏状态                                │
│  - 棋盘状态和单元格值                                        │
│  - 移动历史记录（用于撤销）                                  │
│  - 游戏配置（大小、地雷数量、变体）                          │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                       核心逻辑                              │
│  solver.py - 基于 Z3 的约束求解器                            │
│  variant_rules.py - 各变体的邻居计算逻辑                     │
│  constants.py - 共享常量                                     │
└─────────────────────────────────────────────────────────────┘
```

## 项目结构

```txt
v-14-mine/
├── main.py              # 应用程序入口点
├── core/
│   ├── __init__.py
│   ├── solver.py        # Z3 约束求解器
│   ├── variant_rules.py # 邻居计算逻辑
│   └── constants.py     # 核心常量（单元格状态、变体）
└── gui/
    ├── __init__.py
    ├── pygame_gui.py    # Pygame 视图实现
    ├── presenter.py     # MVP 表示器
    ├── game_state.py    # 游戏状态模型
    └── constants.py     # GUI 颜色和样式
```

## 游戏变体

求解器支持三种邻居计算变体：

1. **标准**：8 个邻居（相邻和对角单元格）
2. **骑士**：标准 8 个 + 8 个骑士移动（L 形）
3. **曼哈顿**：标准 8 个 + 4 个距离为 2 的正交单元格

## 安装

### 要求

- Python 3.12+
- Pygame
- Z3 Solver

### 安装依赖

```bash
pip install pygame z3-solver
```

## 使用方法

### 运行应用程序

```bash
python main.py
```

### 控制操作

- **左键点击**：循环切换单元格值（未知 → 1 → 2 → ... → 8 → 0 → 未知）
- **右键点击**：在单元格上切换旗帜标记
- **Ctrl+Z**：撤销上一步操作
- **规则按钮**：循环切换变体（标准 → 骑士 → 曼哈顿）
- **大小 +/-**：调整网格大小（保持正方形网格）
- **地雷 +/-**：调整总地雷数量
- **重置**：清空棋盘
- **求解**：运行 Z3 求解器查找确定移动

### 单元格状态

- **未知 (-1)**：灰色单元格，未揭开
- **旗帜 (-2)**：单元格标记有红色的 "F"
- **已揭开 (0-8)**：白色单元格，显示数字（相邻地雷数量）

### 求解器输出

- **绿色高亮**：确定安全的单元格
- **红色高亮**：确定是地雷的单元格

## 求解器工作原理

求解器使用 `Z3` 创建一个约束满足问题：

1. 为每个单元格创建一个布尔变量（是否为地雷）
2. 为已揭开的单元格添加约束（相邻地雷之和 = 单元格值）
3. 可选地添加总地雷数量约束
4. 对于每个未知单元格，测试它是否必须是地雷或必须是安全的
5. 返回所有可以确定性的单元格

## 添加新变体

- 将变体名称添加到 `core/constants.py`：

```python
VARIANT_CUSTOM = "Custom"
VARIANT_TYPES.append(VARIANT_CUSTOM)
```

- 在 `core/variant_rules.py` 中添加邻居逻辑：

```python
elif variant_type == VARIANT_CUSTOM:
    offsets = [your_custom_offsets]
```
